name: Quick Tests

on:
  push:
    branches-ignore: [ main ]
  pull_request:
    types: [opened, synchronize, reopened]

env:
  SECRET_KEY: quick-test-secret-key
  ENVIRONMENT: test
  DEBUG: false

jobs:
  quick-validation:
    name: âš¡ ValidaÃ§Ã£o RÃ¡pida
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ” Checkout cÃ³digo
      uses: actions/checkout@v4

    - name: ğŸ Configurar Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        cache: 'pip'

    - name: ğŸ“¦ Instalar dependÃªncias essenciais
      run: |
        cd backend
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install -r tests/requirements-test.txt

    - name: ğŸ” Verificar sintaxe Python
      run: |
        cd backend
        python -m py_compile $(find . -name "*.py" -not -path "./venv/*")

    - name: ğŸ“‹ Verificar imports e estrutura
      run: |
        cd backend
        python -c "
        import sys
        sys.path.append('.')
        
        # Verificar imports principais
        try:
            from app.api.v1.router import api_router
            from app.core.config import settings
            from app.models import user, dataset, model
            print('âœ… Imports principais OK')
        except ImportError as e:
            print(f'âŒ Erro de import: {e}')
            sys.exit(1)
        "

    - name: ğŸ§ª Testes unitÃ¡rios bÃ¡sicos (se existirem)
      run: |
        cd backend
        if [ -d "tests/unit" ]; then
          python -m pytest tests/unit/ -v --tb=short
        else
          echo "âš ï¸ Nenhum teste unitÃ¡rio encontrado"
        fi

    - name: ğŸš€ Verificar se a aplicaÃ§Ã£o inicia
      run: |
        cd backend
        timeout 30s python -c "
        import uvicorn
        from main import app
        
        # Tentar importar a aplicaÃ§Ã£o
        print('âœ… AplicaÃ§Ã£o importada com sucesso')
        
        # Verificar se os endpoints estÃ£o registrados
        routes = [route.path for route in app.routes]
        if '/api/v1' in str(routes):
            print('âœ… Rotas da API registradas')
        else:
            print('âš ï¸ Rotas da API nÃ£o encontradas')
        " || echo "âš ï¸ Timeout na verificaÃ§Ã£o da aplicaÃ§Ã£o"

  lint-and-format:
    name: ğŸ¨ Lint & Format
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ” Checkout cÃ³digo
      uses: actions/checkout@v4

    - name: ğŸ Configurar Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: ğŸ“¦ Instalar ferramentas de linting
      run: |
        pip install flake8 black isort

    - name: ğŸ¨ Verificar formataÃ§Ã£o com Black
      run: |
        cd backend
        black --check --diff app/ tests/ || echo "âš ï¸ CÃ³digo nÃ£o estÃ¡ formatado com Black"

    - name: ğŸ“ Verificar com Flake8
      run: |
        cd backend
        flake8 app/ --max-line-length=88 --extend-ignore=E203,W503 || echo "âš ï¸ Issues encontradas com Flake8"

    - name: ğŸ”„ Verificar imports com isort
      run: |
        cd backend
        isort --check-only --diff app/ tests/ || echo "âš ï¸ Imports nÃ£o estÃ£o organizados"

  docker-build:
    name: ğŸ³ Docker Build Test
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ” Checkout cÃ³digo
      uses: actions/checkout@v4

    - name: ğŸ³ Configurar Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: ğŸ—ï¸ Build da imagem do backend
      run: |
        docker build -t vur-backend:test ./backend

    - name: ğŸ§ª Testar container do backend
      run: |
        # Iniciar container em background
        docker run -d --name vur-test \
          -e SECRET_KEY=test-key \
          -e ENVIRONMENT=test \
          -e DEBUG=false \
          -p 8000:8000 \
          vur-backend:test

        # Aguardar inicializaÃ§Ã£o
        sleep 10

        # Verificar se estÃ¡ rodando
        if docker ps | grep vur-test; then
          echo "âœ… Container iniciado com sucesso"
        else
          echo "âŒ Container falhou ao iniciar"
          docker logs vur-test
          exit 1
        fi

    - name: ğŸ§¹ Limpar containers de teste
      if: always()
      run: |
        docker stop vur-test || true
        docker rm vur-test || true 