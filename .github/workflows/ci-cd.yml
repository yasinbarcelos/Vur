name: CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

env:
  # ConfiguraÃ§Ãµes de ambiente para testes
  POSTGRES_DB: vur_test_db
  POSTGRES_USER: vur_test_user
  POSTGRES_PASSWORD: vur_test_password
  SECRET_KEY: test-secret-key-for-ci-cd-only
  ENVIRONMENT: test
  DEBUG: false
  DATABASE_URL: postgresql://vur_test_user:vur_test_password@localhost:5432/vur_test_db

jobs:
  # Job para testes do backend
  backend-tests:
    name: ðŸ Backend Tests
    runs-on: ubuntu-latest
    
    services:
      # PostgreSQL para testes
      postgres:
        image: postgres:15-alpine
        env:
          POSTGRES_DB: ${{ env.POSTGRES_DB }}
          POSTGRES_USER: ${{ env.POSTGRES_USER }}
          POSTGRES_PASSWORD: ${{ env.POSTGRES_PASSWORD }}
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

      # Redis para cache (opcional)
      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
    - name: ðŸ” Checkout cÃ³digo
      uses: actions/checkout@v4

    - name: ðŸ Configurar Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        cache: 'pip'

    - name: ðŸ“¦ Instalar dependÃªncias do backend
      run: |
        cd backend
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install -r tests/requirements-test.txt

    - name: ðŸ—ƒï¸ Configurar banco de dados
      run: |
        cd backend
        # Executar migraÃ§Ãµes
        alembic upgrade head
      env:
        DATABASE_URL: ${{ env.DATABASE_URL }}

    - name: ðŸ§ª Executar testes rÃ¡pidos
      run: |
        cd backend/tests
        python run_tests.py --quick --base-url http://localhost:8000/api/v1 --verbose
      continue-on-error: false

    - name: ðŸ§ª Executar testes completos de autenticaÃ§Ã£o
      run: |
        cd backend/tests
        python run_tests.py --auth --base-url http://localhost:8000/api/v1 --verbose
      continue-on-error: false

  # Job para build e teste com Docker
  docker-tests:
    name: ðŸ³ Docker Build & Tests
    runs-on: ubuntu-latest
    needs: backend-tests

    steps:
    - name: ðŸ” Checkout cÃ³digo
      uses: actions/checkout@v4

    - name: ðŸ³ Configurar Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: ðŸ“ Criar arquivo .env para testes
      run: |
        cat > .env << EOF
        # ConfiguraÃ§Ã£o para testes CI/CD
        POSTGRES_DB=${{ env.POSTGRES_DB }}
        POSTGRES_USER=${{ env.POSTGRES_USER }}
        POSTGRES_PASSWORD=${{ env.POSTGRES_PASSWORD }}
        SECRET_KEY=${{ env.SECRET_KEY }}
        ENVIRONMENT=test
        DEBUG=false
        LOG_LEVEL=INFO
        BACKEND_PORT=8000
        FRONTEND_PORT=3000
        REDIS_PORT=6379
        VITE_API_URL=http://localhost:8000/api/v1
        ALLOWED_ORIGINS=http://localhost:3000,http://localhost:5173
        EOF

    - name: ðŸ—ï¸ Build das imagens Docker
      run: |
        echo "ðŸ—ï¸ Construindo imagem do backend..."
        docker-compose -f docker-compose.dev.yml build backend
        
        echo "ðŸ—ï¸ Construindo imagem do frontend..."
        docker-compose -f docker-compose.dev.yml build frontend

    - name: ðŸš€ Iniciar serviÃ§os Docker
      run: |
        echo "ðŸš€ Iniciando serviÃ§os..."
        docker-compose -f docker-compose.dev.yml up -d postgres redis
        
        echo "â³ Aguardando PostgreSQL..."
        timeout 60 bash -c 'until docker-compose -f docker-compose.dev.yml exec -T postgres pg_isready -U ${{ env.POSTGRES_USER }}; do sleep 2; done'
        
        echo "ðŸš€ Iniciando backend..."
        docker-compose -f docker-compose.dev.yml up -d backend
        
        echo "â³ Aguardando backend..."
        timeout 120 bash -c 'until curl -f http://localhost:8000/health; do sleep 5; done'

    - name: ðŸ“Š Verificar status dos containers
      run: |
        echo "ðŸ“Š Status dos containers:"
        docker-compose -f docker-compose.dev.yml ps
        
        echo -e "\nðŸ“ Logs do backend:"
        docker-compose -f docker-compose.dev.yml logs backend --tail=50

    - name: ðŸ§ª Executar testes no ambiente Docker
      run: |
        echo "ðŸ§ª Executando testes no ambiente Docker..."
        
        # Instalar dependÃªncias de teste no container
        docker-compose -f docker-compose.dev.yml exec -T backend pip install -r tests/requirements-test.txt
        
        # Executar testes
        docker-compose -f docker-compose.dev.yml exec -T backend python tests/run_tests.py --quick --verbose
        docker-compose -f docker-compose.dev.yml exec -T backend python tests/run_tests.py --production --verbose

    - name: ðŸ§¹ Cleanup
      if: always()
      run: |
        echo "ðŸ§¹ Limpando containers..."
        docker-compose -f docker-compose.dev.yml down -v
        docker system prune -f

  # Job para verificaÃ§Ãµes de seguranÃ§a e qualidade
  security-checks:
    name: ðŸ”’ Security & Quality Checks
    runs-on: ubuntu-latest
    
    steps:
    - name: ðŸ” Checkout cÃ³digo
      uses: actions/checkout@v4

    - name: ðŸ Configurar Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: ðŸ”’ Verificar vulnerabilidades de seguranÃ§a
      run: |
        cd backend
        pip install safety bandit
        
        echo "ðŸ” Verificando vulnerabilidades com Safety..."
        safety check -r requirements.txt || echo "âš ï¸ Vulnerabilidades encontradas"
        
        echo "ðŸ” AnÃ¡lise de seguranÃ§a com Bandit..."
        bandit -r app/ -f json -o bandit-report.json || echo "âš ï¸ Problemas de seguranÃ§a encontrados"

    - name: ðŸ“Š Upload dos relatÃ³rios de seguranÃ§a
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: security-reports
        path: backend/bandit-report.json

  # Job para deploy (apenas no branch main)
  deploy:
    name: ðŸš€ Deploy
    runs-on: ubuntu-latest
    needs: [backend-tests, docker-tests, security-checks]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    steps:
    - name: ðŸ” Checkout cÃ³digo
      uses: actions/checkout@v4

    - name: ðŸ“ Preparar para deploy
      run: |
        echo "ðŸš€ Preparando artefatos para deploy..."
        echo "Commit: ${{ github.sha }}"
        echo "Branch: ${{ github.ref }}"
        
        # Aqui vocÃª pode adicionar steps especÃ­ficos para seu ambiente de produÃ§Ã£o
        # Por exemplo: build de imagens para produÃ§Ã£o, deploy para cloud, etc.

    - name: ðŸ“Š Notificar sucesso
      run: |
        echo "âœ… Pipeline executado com sucesso!"
        echo "ðŸŽ‰ Todos os testes passaram"
        echo "ðŸ”’ VerificaÃ§Ãµes de seguranÃ§a concluÃ­das"
        echo "ðŸ³ Build Docker bem-sucedido" 